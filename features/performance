local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local LocalPlayer = Players.LocalPlayer
local FPS_SUPPORTED = typeof(setfpscap) == "function"

local Performance = {}

local lastTime, frameCount, currentFPS = tick(), 0, 60
local updateInterval = 1

local FPSHistory = {}
local PingHistory = {}
local MAX_POINTS = 60

for i = 1, MAX_POINTS do
    table.insert(FPSHistory, 60)
    table.insert(PingHistory, 0)
end

function Performance.IsFPSUnlockSupported()
    return FPS_SUPPORTED
end

function Performance.SetFPSCap(fps)
    if FPS_SUPPORTED then
        setfpscap(fps)
        return true
    end
    return false
end

function Performance.UpdateFPSStats(fps)
    table.remove(FPSHistory, 1)
    table.insert(FPSHistory, fps)
    
    local minFPS, maxFPS, totalFPS = math.huge, 0, 0
    for _, fpsVal in ipairs(FPSHistory) do
        minFPS = math.min(minFPS, fpsVal)
        maxFPS = math.max(maxFPS, fpsVal)
        totalFPS = totalFPS + fpsVal
    end
    local avgFPS = math.floor(totalFPS / #FPSHistory)
    
    return {
        current = fps,
        average = avgFPS,
        min = minFPS,
        max = maxFPS
    }
end

function Performance.UpdatePingStats(ping)
    table.remove(PingHistory, 1)
    table.insert(PingHistory, ping)
    
    local minPing, maxPing, totalPing = math.huge, 0, 0
    for _, pingVal in ipairs(PingHistory) do
        minPing = math.min(minPing, pingVal)
        maxPing = math.max(maxPing, pingVal)
        totalPing = totalPing + pingVal
    end
    local avgPing = math.floor(totalPing / #PingHistory)
    
    local qualityText, qualityColor
    if ping < 50 then
        qualityText, qualityColor = "Excellent", Color3.fromRGB(50, 220, 100)
    elseif ping < 100 then
        qualityText, qualityColor = "Good", Color3.fromRGB(100, 200, 255)
    elseif ping < 200 then
        qualityText, qualityColor = "Fair", Color3.fromRGB(255, 200, 100)
    elseif ping < 300 then
        qualityText, qualityColor = "Poor", Color3.fromRGB(255, 150, 50)
    else
        qualityText, qualityColor = "Very Poor", Color3.fromRGB(220, 50, 50)
    end
    
    return {
        current = ping,
        average = avgPing,
        min = minPing,
        max = maxPing,
        quality = qualityText,
        qualityColor = qualityColor
    }
end

function Performance.StartMonitoring(callbacks)
    local fpsCallback = callbacks.onFPSUpdate
    local pingCallback = callbacks.onPingUpdate
    
    RunService.RenderStepped:Connect(function()
        frameCount = frameCount + 1
        local currentTime = tick()
        if currentTime - lastTime >= updateInterval then
            currentFPS = math.floor(frameCount / (currentTime - lastTime))
            frameCount = 0
            lastTime = currentTime
            
            if fpsCallback then
                local stats = Performance.UpdateFPSStats(currentFPS)
                fpsCallback(stats)
            end
        end
        
        if frameCount % 30 == 0 and pingCallback then
            local ping = math.floor(LocalPlayer:GetNetworkPing() * 1000)
            local stats = Performance.UpdatePingStats(ping)
            pingCallback(stats)
        end
    end)
end

return Performance
