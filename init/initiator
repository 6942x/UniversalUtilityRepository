local TweenService = game:GetService("TweenService")

local Config = _G.UniversalUtility.Config
local UI = _G.UniversalUtility.UI
local Interactions = _G.UniversalUtility.Interactions
local AntiAFK = _G.UniversalUtility.AntiAFK
local KeySpam = _G.UniversalUtility.KeySpam
local AutoRejoin = _G.UniversalUtility.AutoRejoin
local Performance = _G.UniversalUtility.Performance

local tabList = {
    {"Home", "üè†", UDim2.new(0, 5, 0, 5)},
    {"Anti-AFK", "üõ°Ô∏è", UDim2.new(0, 5, 0, 68)},
    {"KeySpam", "‚å®Ô∏è", UDim2.new(0, 5, 0, 131)},
    {"Performance Status", "üìä", UDim2.new(0, 5, 0, 194)},
    {"Auto Rejoin", "üîÑ", UDim2.new(0, 5, 0, 257)},
    {"Script Loader", "üíæ", UDim2.new(0, 5, 0, 320)},
    {"Settings", "‚öôÔ∏è", UDim2.new(0, 5, 0, 383)}
}

for _, tab in ipairs(tabList) do
    UI.CreateTabButton(tab[1], tab[2], tab[3])
end

for _, tab in ipairs(tabList) do
    UI.CreateTabContent(tab[1])
end

local configLoaded = _G.UniversalUtility.LoadConfig()

if configLoaded then
    local KeyCodeNames = _G.UniversalUtility.KeyCodeNames
    local KeybindButton = _G.UniversalUtility.SettingsTab.KeybindButton
    local keyName = KeyCodeNames[Config.Keybind] or Config.Keybind.Name
    KeybindButton.Text = "Toggle Keybind: " .. keyName
    
    local SpamInput = _G.UniversalUtility.KeySpamTab.SpamInput
    if SpamInput then
        SpamInput.Text = Config.SpamKey
    end
    
    local LoadStringBox = _G.UniversalUtility.ScriptLoaderTab.LoadStringBox
    if LoadStringBox then
        LoadStringBox.Text = Config.SavedCode
    end
    
    if _G.UniversalUtility.AntiAFKTab then
        _G.UniversalUtility.AntiAFKTab.UpdateJumpSlider((Config.JumpDelay - 5) / 25)
        _G.UniversalUtility.AntiAFKTab.UpdateClickSlider((Config.ClickDelay - 1) / 9)
        _G.UniversalUtility.AntiAFKTab.UpdateClickTypeButtons()
    end
    
    if _G.UniversalUtility.KeySpamTab then
        _G.UniversalUtility.KeySpamTab.UpdateSpamSlider((Config.SpamDelay - 0.05) / 4.95)
    end
    
    if _G.UniversalUtility.PerformanceTab then
        _G.UniversalUtility.PerformanceTab.UpdateFPSSlider((Config.TargetFPS - 15) / 345)
    end
    
    if Config.AutoRejoinEnabled then
        local AutoRejoinTab = _G.UniversalUtility.AutoRejoinTab
        AutoRejoinTab.AutoRejoinToggle.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
        AutoRejoinTab.AutoRejoinToggle.Text = "Auto Rejoin: ON"
        AutoRejoinTab.AutoRejoinStatus.Text = "Status: Enabled\n\nAutomatically rejoins the game when you get disconnected.\nUseful for preventing AFK kicks."
        AutoRejoinTab.AutoRejoinStatus.TextColor3 = Color3.fromRGB(50, 220, 100)
        AutoRejoin.Setup()
    else
        local AutoRejoinTab = _G.UniversalUtility.AutoRejoinTab
        AutoRejoinTab.AutoRejoinToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
        AutoRejoinTab.AutoRejoinToggle.Text = "Auto Rejoin: OFF"
        AutoRejoinTab.AutoRejoinStatus.Text = "Status: Disabled\n\nAutomatically rejoins the game when you get disconnected.\nUseful for preventing AFK kicks."
        AutoRejoinTab.AutoRejoinStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
    end
    
    if Config.FPSUnlockEnabled and Performance.FPS_SUPPORTED then
        local PerformanceTab = _G.UniversalUtility.PerformanceTab
        PerformanceTab.FPSUnlockToggle.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
        PerformanceTab.FPSUnlockToggle.Text = "FPS Unlock: ON"
        PerformanceTab.FPSUnlockStatus.TextColor3 = Color3.fromRGB(50, 220, 100)
        PerformanceTab.FPSUnlockStatus.Text = "Your target: " .. Config.TargetFPS .. " FPS"
        setfpscap(Config.TargetFPS)
    else
        local PerformanceTab = _G.UniversalUtility.PerformanceTab
        PerformanceTab.FPSUnlockToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
        PerformanceTab.FPSUnlockToggle.Text = "FPS Unlock: OFF"
        PerformanceTab.FPSUnlockStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
        PerformanceTab.FPSUnlockStatus.Text = "Default FPS"
    end
    
    _G.UniversalUtility.CleanupAllThreads()
    
    if Config.JumpEnabled then
        task.wait(0.1)
        local AntiAFKTab = _G.UniversalUtility.AntiAFKTab
        AntiAFKTab.JumpToggle.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
        AntiAFKTab.JumpToggle.Text = "Auto Jump: ON"
        AntiAFK.StartJump()
    else
        local AntiAFKTab = _G.UniversalUtility.AntiAFKTab
        AntiAFKTab.JumpToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
        AntiAFKTab.JumpToggle.Text = "Auto Jump: OFF"
    end
    
    if Config.ClickEnabled then
        task.wait(0.1)
        local AntiAFKTab = _G.UniversalUtility.AntiAFKTab
        AntiAFKTab.ClickToggle.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
        AntiAFKTab.ClickToggle.Text = "Auto Click: ON"
        AntiAFK.StartClick()
    else
        local AntiAFKTab = _G.UniversalUtility.AntiAFKTab
        AntiAFKTab.ClickToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
        AntiAFKTab.ClickToggle.Text = "Auto Click: OFF"
    end
    
    if Config.AutoSpamEnabled then
        local KeyCodeMap = _G.UniversalUtility.KeyCodeMap
        local keyCode = KeyCodeMap[Config.SpamKey]
        if keyCode then
            task.wait(0.1)
            local KeySpamTab = _G.UniversalUtility.KeySpamTab
            KeySpamTab.AutoSpamToggle.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
            KeySpamTab.AutoSpamToggle.Text = "ON"
            KeySpamTab.AutoSpamStatus.Text = "Status: Spamming " .. Config.SpamKey
            KeySpamTab.AutoSpamStatus.TextColor3 = Color3.fromRGB(50, 220, 100)
            KeySpam.Start()
        else
            Config.AutoSpamEnabled = false
            local KeySpamTab = _G.UniversalUtility.KeySpamTab
            KeySpamTab.AutoSpamToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
            KeySpamTab.AutoSpamToggle.Text = "OFF"
            KeySpamTab.AutoSpamStatus.Text = "Status: Inactive"
            KeySpamTab.AutoSpamStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
        end
    else
        local KeySpamTab = _G.UniversalUtility.KeySpamTab
        KeySpamTab.AutoSpamToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
        KeySpamTab.AutoSpamToggle.Text = "OFF"
        KeySpamTab.AutoSpamStatus.Text = "Status: Inactive"
        KeySpamTab.AutoSpamStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
    end
    
    if _G.UniversalUtility.AntiAFKTab then
        _G.UniversalUtility.AntiAFKTab.UpdateAntiAFKStatus()
    end
else
    if _G.UniversalUtility.AntiAFKTab then
        _G.UniversalUtility.AntiAFKTab.UpdateJumpSlider(0.2)
        _G.UniversalUtility.AntiAFKTab.UpdateClickSlider(0.22)
        _G.UniversalUtility.AntiAFKTab.UpdateClickTypeButtons()
    end
    
    if _G.UniversalUtility.KeySpamTab then
        _G.UniversalUtility.KeySpamTab.UpdateSpamSlider(0.01)
    end
    
    if _G.UniversalUtility.PerformanceTab then
        _G.UniversalUtility.PerformanceTab.UpdateFPSSlider(0.13)
    end
    
    local AntiAFKTab = _G.UniversalUtility.AntiAFKTab
    AntiAFKTab.JumpToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    AntiAFKTab.JumpToggle.Text = "Auto Jump: OFF"
    
    AntiAFKTab.ClickToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    AntiAFKTab.ClickToggle.Text = "Auto Click: OFF"
    
    local KeySpamTab = _G.UniversalUtility.KeySpamTab
    KeySpamTab.AutoSpamToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    KeySpamTab.AutoSpamToggle.Text = "OFF"
    KeySpamTab.AutoSpamStatus.Text = "Status: Inactive"
    KeySpamTab.AutoSpamStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
    
    local PerformanceTab = _G.UniversalUtility.PerformanceTab
    PerformanceTab.FPSUnlockToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    PerformanceTab.FPSUnlockToggle.Text = "FPS Unlock: OFF"
    PerformanceTab.FPSUnlockStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
    PerformanceTab.FPSUnlockStatus.Text = "Default FPS"
    
    local AutoRejoinTab = _G.UniversalUtility.AutoRejoinTab
    AutoRejoinTab.AutoRejoinToggle.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    AutoRejoinTab.AutoRejoinToggle.Text = "Auto Rejoin: OFF"
    AutoRejoinTab.AutoRejoinStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
end

for _, tab in ipairs(tabList) do
    local name = tab[1]
    UI.TabButtons[name].Button.MouseButton1Click:Connect(function()
        Interactions.SwitchTab(name)
    end)
end

Interactions.SwitchTab(Config.CurrentTab)

Interactions.SetupCloseButton()
Interactions.SetupReopenButton()
Interactions.SetupKeybindToggle()

UI.MainFrame.Visible = true
UI.MainFrame.Size = UDim2.new(0, 0, 0, 0)
UI.MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
UI.ReopenButton.Visible = false

TweenService:Create(UI.MainFrame, TweenInfo.new(0.8, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
    Size = UDim2.new(0, 650, 0, 500),
    Position = UDim2.new(0.5, -325, 0.5, -250)
}):Play()

UI.ScreenGui.Destroying:Connect(_G.UniversalUtility.CleanupAllThreads)

print("[Universal Utility] Initiator completed - GUI ready")
