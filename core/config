local HttpService = game:GetService("HttpService")

if _G.UniversalUtility and _G.UniversalUtility.ActiveThreads then
    for threadType, thread in pairs(_G.UniversalUtility.ActiveThreads) do
        if thread and typeof(thread) == "thread" then
            pcall(function()
                task.cancel(thread)
            end)
        end
    end
    _G.UniversalUtility.ActiveThreads = {}
end

_G.UniversalUtility = _G.UniversalUtility or {}
_G.UniversalUtility.ActiveThreads = {}
_G.UniversalUtility.Config = {
    Keybind = Enum.KeyCode.G,
    ClickType = "Current",
    JumpEnabled = false,
    ClickEnabled = false,
    AutoSpamEnabled = false,
    IsChangingKeybind = false,
    FPSUnlockEnabled = false,
    AutoRejoinEnabled = false,
    TargetFPS = 60,
    JumpDelay = 10.0,
    ClickDelay = 3.0,
    SpamDelay = 0.1,
    SpamKey = "Q",
    SavedCode = "",
    CurrentTab = "Home"
}

local Config = _G.UniversalUtility.Config

function _G.UniversalUtility.SaveConfig()
    if writefile then
        local configData = HttpService:JSONEncode({
            Keybind = Config.Keybind.Name,
            ClickType = Config.ClickType,
            JumpEnabled = Config.JumpEnabled,
            ClickEnabled = Config.ClickEnabled,
            AutoRejoinEnabled = Config.AutoRejoinEnabled,
            FPSUnlockEnabled = Config.FPSUnlockEnabled,
            AutoSpamEnabled = Config.AutoSpamEnabled,
            TargetFPS = Config.TargetFPS,
            JumpDelay = Config.JumpDelay,
            ClickDelay = Config.ClickDelay,
            SpamDelay = Config.SpamDelay,
            SpamKey = Config.SpamKey,
            SavedCode = Config.SavedCode,
            CurrentTab = Config.CurrentTab
        })
        writefile("UniversalUtilityConfig.json", configData)
    end
end

function _G.UniversalUtility.LoadConfig()
    if readfile and isfile and isfile("UniversalUtilityConfig.json") then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile("UniversalUtilityConfig.json"))
        end)
        if success and data then
            Config.Keybind = Enum.KeyCode[data.Keybind] or Enum.KeyCode.G
            Config.ClickType = data.ClickType or "Current"
            Config.JumpEnabled = data.JumpEnabled or false
            Config.ClickEnabled = data.ClickEnabled or false
            Config.AutoRejoinEnabled = data.AutoRejoinEnabled or false
            Config.FPSUnlockEnabled = data.FPSUnlockEnabled or false
            Config.AutoSpamEnabled = data.AutoSpamEnabled or false
            Config.TargetFPS = data.TargetFPS or 60
            Config.JumpDelay = data.JumpDelay or 10.0
            Config.ClickDelay = data.ClickDelay or 3.0
            Config.SpamDelay = data.SpamDelay or 0.1
            Config.SpamKey = data.SpamKey or "Q"
            Config.SavedCode = data.SavedCode or ""
            Config.CurrentTab = data.CurrentTab or "Home"
            return true
        end
    end
    return false
end

return _G.UniversalUtility.Config
