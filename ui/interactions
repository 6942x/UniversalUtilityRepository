local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local Config = _G.UniversalUtility.Config
local UI = _G.UniversalUtility.UI
local Debounces = _G.UniversalUtility.Debounces

_G.UniversalUtility.Interactions = {}

local function SetDebounce(key, duration)
    if Debounces[key] then return false end
    Debounces[key] = true
    task.delay(duration or 0.3, function() Debounces[key] = false end)
    return true
end

function _G.UniversalUtility.Interactions.ToggleUI()
    if not SetDebounce("UI", 0.8) then return end
    local MainFrame = UI.MainFrame
    local ReopenButton = UI.ReopenButton
    
    if MainFrame.Visible then
        TweenService:Create(MainFrame, UI.TweenPresets.BackIn, {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0)
        }):Play()
        task.wait(0.45)
        MainFrame.Visible = false
        ReopenButton.Visible = true
        ReopenButton.Size = UDim2.new(0, 0, 0, 0)
        ReopenButton.Position = UDim2.new(0.5, 0, 0, 30)
        TweenService:Create(ReopenButton, UI.TweenPresets.Back, {
            Size = UDim2.new(0, 60, 0, 60),
            Position = UDim2.new(0.5, -30, 0, 30)
        }):Play()
    else
        TweenService:Create(ReopenButton, UI.TweenPresets.BackIn, {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0, 30)
        }):Play()
        task.wait(0.35)
        ReopenButton.Visible = false
        MainFrame.Visible = true
        MainFrame.Size = UDim2.new(0, 0, 0, 0)
        MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
        TweenService:Create(MainFrame, UI.TweenPresets.Back, {
            Size = UDim2.new(0, 650, 0, 500),
            Position = UDim2.new(0.5, -325, 0.5, -250)
        }):Play()
    end
end

function _G.UniversalUtility.Interactions.SwitchTab(tabName)
    if not SetDebounce("Tab", 0.1) then return end
    Config.CurrentTab = tabName
    _G.UniversalUtility.SaveConfig()
    
    for name, content in pairs(UI.TabContents) do
        content.Visible = (name == tabName)
    end
    
    for name, tabData in pairs(UI.TabButtons) do
        local isActive = (name == tabName)
        TweenService:Create(tabData.Button, UI.TweenPresets.Fast, {
            BackgroundColor3 = isActive and Color3.fromRGB(100, 150, 255) or Color3.fromRGB(35, 35, 42)
        }):Play()
        TweenService:Create(tabData.Icon, UI.TweenPresets.Fast, {
            TextColor3 = isActive and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(180, 180, 180)
        }):Play()
        TweenService:Create(tabData.Label, UI.TweenPresets.Fast, {
            TextColor3 = isActive and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(180, 180, 180)
        }):Play()
    end
end

function _G.UniversalUtility.Interactions.ChangeKeybind(callback)
    if not SetDebounce("Keybind", 0.5) or Config.IsChangingKeybind then return end
    Config.IsChangingKeybind = true
    
    local connection
    local timeout = task.delay(5, function()
        if connection then
            connection:Disconnect()
            Config.IsChangingKeybind = false
            if callback then callback(false, "Timeout") end
        end
    end)
    
    connection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if input.UserInputType == Enum.UserInputType.Keyboard and not gameProcessed then
            task.cancel(timeout)
            
            Config.Keybind = input.KeyCode
            _G.UniversalUtility.SaveConfig()
            
            connection:Disconnect()
            
            task.delay(0.1, function()
                Config.IsChangingKeybind = false
            end)
            
            if callback then callback(true, input.KeyCode) end
        end
    end)
end

function _G.UniversalUtility.Interactions.SetupKeybindToggle()
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Config.Keybind and not Config.IsChangingKeybind then
            _G.UniversalUtility.Interactions.ToggleUI()
        end
    end)
end

function _G.UniversalUtility.Interactions.SetupCloseButton()
    UI.CloseButton.MouseEnter:Connect(function()
        TweenService:Create(UI.CloseButton, UI.TweenPresets.Fast, {
            BackgroundColor3 = Color3.fromRGB(240, 70, 70),
            Size = UDim2.new(0, 32, 0, 32)
        }):Play()
    end)

    UI.CloseButton.MouseLeave:Connect(function()
        TweenService:Create(UI.CloseButton, UI.TweenPresets.Fast, {
            BackgroundColor3 = Color3.fromRGB(220, 50, 50),
            Size = UDim2.new(0, 30, 0, 30)
        }):Play()
    end)

    UI.CloseButton.MouseButton1Down:Connect(function()
        TweenService:Create(UI.CloseButton, TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 28, 0, 28)
        }):Play()
    end)

    UI.CloseButton.MouseButton1Up:Connect(function()
        TweenService:Create(UI.CloseButton, UI.TweenPresets.Fast, {
            Size = UDim2.new(0, 30, 0, 30)
        }):Play()
    end)
    
    UI.CloseButton.MouseButton1Click:Connect(_G.UniversalUtility.Interactions.ToggleUI)
end

function _G.UniversalUtility.Interactions.SetupReopenButton()
    UI.ReopenButton.MouseEnter:Connect(function()
        TweenService:Create(UI.ReopenButton, UI.TweenPresets.Medium, {
            Size = UDim2.new(0, 70, 0, 70),
            Position = UDim2.new(0.5, -35, 0, 25)
        }):Play()
    end)

    UI.ReopenButton.MouseLeave:Connect(function()
        TweenService:Create(UI.ReopenButton, UI.TweenPresets.Medium, {
            Size = UDim2.new(0, 60, 0, 60),
            Position = UDim2.new(0.5, -30, 0, 30)
        }):Play()
    end)
    
    UI.ReopenButton.MouseButton1Click:Connect(_G.UniversalUtility.Interactions.ToggleUI)
end

print("[Universal Utility] Interactions module loaded")
