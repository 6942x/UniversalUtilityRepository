local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local Config = _G.UniversalUtility.Config
local UI = _G.UniversalUtility.UI
local Debounces = _G.UniversalUtility.Debounces

_G.UniversalUtility.Interactions = {}

local function SetDebounce(key, duration)
    if Debounces[key] then return false end
    Debounces[key] = true
    task.delay(duration or 0.3, function() Debounces[key] = false end)
    return true
end

function _G.UniversalUtility.Interactions.ToggleUI()
    if not SetDebounce("UI", 0.7) then return end
    if UI.MainFrame.Visible then
        local closeTween = TweenService:Create(UI.MainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0)
        })
        
        for _, element in ipairs(UI.MainFrame:GetDescendants()) do
            if element:IsA("GuiObject") and element ~= UI.MainFrame then
                TweenService:Create(element, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
                    BackgroundTransparency = 1,
                    TextTransparency = 1
                }):Play()
            end
        end
        
        closeTween:Play()
        task.wait(0.45)
        UI.MainFrame.Visible = false
        
        UI.ReopenButton.Visible = true
        UI.ReopenButton.Size = UDim2.new(0, 0, 0, 0)
        UI.ReopenButton.Position = UDim2.new(0.5, 0, 0, 30)
        
        TweenService:Create(UI.ReopenButton, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 65, 0, 65),
            Position = UDim2.new(0.5, -32.5, 0, 30)
        }):Play()
    else
        TweenService:Create(UI.ReopenButton, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0, 30)
        }):Play()
        
        task.wait(0.35)
        UI.ReopenButton.Visible = false
        UI.MainFrame.Visible = true
        UI.MainFrame.Size = UDim2.new(0, 0, 0, 0)
        UI.MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
        
        for _, element in ipairs(UI.MainFrame:GetDescendants()) do
            if element:IsA("GuiObject") and element ~= UI.MainFrame then
                local originalTransp = element:GetAttribute("OriginalTransparency")
                if originalTransp then
                    element.BackgroundTransparency = originalTransp
                    element.TextTransparency = 0
                end
            end
        end
        
        local openTween = TweenService:Create(UI.MainFrame, TweenInfo.new(0.6, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 650, 0, 500),
            Position = UDim2.new(0.5, -325, 0.5, -250)
        })
        openTween:Play()
        
        task.wait(0.2)
        for i, element in ipairs(UI.MainFrame:GetDescendants()) do
            if element:IsA("GuiObject") and element ~= UI.MainFrame then
                task.delay(i * 0.01, function()
                    TweenService:Create(element, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                        BackgroundTransparency = element:GetAttribute("OriginalTransparency") or 0,
                        TextTransparency = 0
                    }):Play()
                end)
            end
        end
    end
end

function _G.UniversalUtility.Interactions.SwitchTab(tabName)
    if not SetDebounce("Tab", 0.08) then return end
    Config.CurrentTab = tabName
    _G.UniversalUtility.SaveConfig()
    
    for name, content in pairs(UI.TabContents) do
        if content.Visible then
            TweenService:Create(content, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
                GroupTransparency = 1
            }):Play()
            task.delay(0.15, function()
                content.Visible = false
            end)
        end
    end
    
    task.delay(0.15, function()
        local selectedContent = UI.TabContents[tabName]
        if selectedContent then
            selectedContent.Visible = true
            selectedContent.GroupTransparency = 1
            TweenService:Create(selectedContent, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                GroupTransparency = 0
            }):Play()
        end
    end)
    
    for name, tabData in pairs(UI.TabButtons) do
        local isActive = (name == tabName)
        
        TweenService:Create(tabData.Button, UI.TweenPresets.Smooth, {
            BackgroundColor3 = isActive and Color3.fromRGB(100, 150, 255) or Color3.fromRGB(35, 35, 45),
            Size = isActive and UDim2.new(1, -10, 0, 58) or UDim2.new(1, -14, 0, 58)
        }):Play()
        
        TweenService:Create(tabData.Icon, UI.TweenPresets.Smooth, {
            TextColor3 = isActive and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(180, 180, 180),
            TextSize = isActive and 28 or 26
        }):Play()
        
        TweenService:Create(tabData.Label, UI.TweenPresets.Smooth, {
            TextColor3 = isActive and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(180, 180, 180)
        }):Play()
        
        TweenService:Create(tabData.Glow, UI.TweenPresets.Smooth, {
            ImageTransparency = isActive and 0.5 or 1
        }):Play()
    end
end

function _G.UniversalUtility.Interactions.SetupKeybindListener()
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Config.Keybind and not Config.IsChangingKeybind then
            _G.UniversalUtility.Interactions.ToggleUI()
        end
    end)
end

function _G.UniversalUtility.Interactions.SetupCloseButton()
    UI.CloseButton.MouseButton1Click:Connect(_G.UniversalUtility.Interactions.ToggleUI)
    
    UI.CloseButton.MouseEnter:Connect(function()
        TweenService:Create(UI.CloseButton, UI.TweenPresets.Fast, {
            BackgroundColor3 = Color3.fromRGB(255, 90, 90),
            Size = UDim2.new(0, 38, 0, 38),
            Rotation = 90
        }):Play()
    end)

    UI.CloseButton.MouseLeave:Connect(function()
        TweenService:Create(UI.CloseButton, UI.TweenPresets.Fast, {
            BackgroundColor3 = Color3.fromRGB(255, 70, 70),
            Size = UDim2.new(0, 35, 0, 35),
            Rotation = 0
        }):Play()
    end)

    UI.CloseButton.MouseButton1Down:Connect(function()
        TweenService:Create(UI.CloseButton, TweenInfo.new(0.08, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 32, 0, 32),
            Rotation = 180
        }):Play()
    end)

    UI.CloseButton.MouseButton1Up:Connect(function()
        TweenService:Create(UI.CloseButton, UI.TweenPresets.Fast, {
            Size = UDim2.new(0, 35, 0, 35),
            Rotation = 90
        }):Play()
    end)
end

function _G.UniversalUtility.Interactions.SetupReopenButton()
    UI.ReopenButton.MouseButton1Click:Connect(_G.UniversalUtility.Interactions.ToggleUI)
    
    UI.ReopenButton.MouseEnter:Connect(function()
        TweenService:Create(UI.ReopenButton, UI.TweenPresets.Medium, {
            Size = UDim2.new(0, 75, 0, 75),
            Position = UDim2.new(0.5, -37.5, 0, 25),
            BackgroundColor3 = Color3.fromRGB(120, 170, 255)
        }):Play()
        
        TweenService:Create(UI.ReopenButton:FindFirstChild("ReopenIcon"), UI.TweenPresets.Medium, {
            TextSize = 32,
            Rotation = 15
        }):Play()
    end)

    UI.ReopenButton.MouseLeave:Connect(function()
        TweenService:Create(UI.ReopenButton, UI.TweenPresets.Medium, {
            Size = UDim2.new(0, 65, 0, 65),
            Position = UDim2.new(0.5, -32.5, 0, 30),
            BackgroundColor3 = Color3.fromRGB(100, 150, 255)
        }):Play()
        
        TweenService:Create(UI.ReopenButton:FindFirstChild("ReopenIcon"), UI.TweenPresets.Medium, {
            TextSize = 28,
            Rotation = 0
        }):Play()
    end)
end

return _G.UniversalUtility.Interactions
