local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local Config = _G.UniversalUtility.Config
local FPS_SUPPORTED = typeof(setfpscap) == "function"

_G.UniversalUtility.Performance = {}
_G.UniversalUtility.Performance.FPSHistory = {}
_G.UniversalUtility.Performance.PingHistory = {}
_G.UniversalUtility.Performance.CurrentFPS = 60
_G.UniversalUtility.Performance.FPS_SUPPORTED = FPS_SUPPORTED

local MAX_POINTS = 60
for i = 1, MAX_POINTS do
    table.insert(_G.UniversalUtility.Performance.FPSHistory, 60)
    table.insert(_G.UniversalUtility.Performance.PingHistory, 0)
end

function _G.UniversalUtility.Performance.UpdateFPSStats(fps)
    local FPSHistory = _G.UniversalUtility.Performance.FPSHistory
    table.remove(FPSHistory, 1)
    table.insert(FPSHistory, fps)
    
    local minFPS, maxFPS, totalFPS = math.huge, 0, 0
    for _, fpsVal in ipairs(FPSHistory) do
        minFPS = math.min(minFPS, fpsVal)
        maxFPS = math.max(maxFPS, fpsVal)
        totalFPS = totalFPS + fpsVal
    end
    local avgFPS = math.floor(totalFPS / #FPSHistory)
    
    return fps, avgFPS, minFPS, maxFPS
end

function _G.UniversalUtility.Performance.UpdatePingStats(ping)
    local PingHistory = _G.UniversalUtility.Performance.PingHistory
    table.remove(PingHistory, 1)
    table.insert(PingHistory, ping)
    
    local minPing, maxPing, totalPing = math.huge, 0, 0
    for _, pingVal in ipairs(PingHistory) do
        minPing = math.min(minPing, pingVal)
        maxPing = math.max(maxPing, pingVal)
        totalPing = totalPing + pingVal
    end
    local avgPing = math.floor(totalPing / #PingHistory)
    
    local qualityText, qualityColor
    if ping < 50 then
        qualityText, qualityColor = "Excellent", Color3.fromRGB(50, 220, 100)
    elseif ping < 100 then
        qualityText, qualityColor = "Good", Color3.fromRGB(100, 200, 255)
    elseif ping < 200 then
        qualityText, qualityColor = "Fair", Color3.fromRGB(255, 200, 100)
    elseif ping < 300 then
        qualityText, qualityColor = "Poor", Color3.fromRGB(255, 150, 50)
    else
        qualityText, qualityColor = "Very Poor", Color3.fromRGB(220, 50, 50)
    end
    
    return ping, avgPing, minPing, maxPing, qualityText, qualityColor
end

function _G.UniversalUtility.Performance.ToggleFPS()
    if not FPS_SUPPORTED then
        return false, "FPS Unlock not supported"
    end
    
    Config.FPSUnlockEnabled = not Config.FPSUnlockEnabled
    
    if Config.FPSUnlockEnabled then
        setfpscap(Config.TargetFPS)
    else
        setfpscap(60)
    end
    
    _G.UniversalUtility.SaveConfig()
    return Config.FPSUnlockEnabled
end

function _G.UniversalUtility.Performance.SetTargetFPS(fps)
    Config.TargetFPS = math.clamp(fps, 15, 360)
    if Config.FPSUnlockEnabled and FPS_SUPPORTED then
        setfpscap(Config.TargetFPS)
    end
    _G.UniversalUtility.SaveConfig()
end

function _G.UniversalUtility.Performance.StartMonitoring(fpsCallback, pingCallback)
    local lastTime, frameCount = tick(), 0
    local updateInterval = 1
    
    RunService.RenderStepped:Connect(function()
        frameCount = frameCount + 1
        local currentTime = tick()
        if currentTime - lastTime >= updateInterval then
            local currentFPS = math.floor(frameCount / (currentTime - lastTime))
            frameCount = 0
            lastTime = currentTime
            _G.UniversalUtility.Performance.CurrentFPS = currentFPS
            
            if fpsCallback then
                local fps, avgFPS, minFPS, maxFPS = _G.UniversalUtility.Performance.UpdateFPSStats(currentFPS)
                fpsCallback(fps, avgFPS, minFPS, maxFPS)
            end
        end
        
        if frameCount % 30 == 0 and pingCallback then
            local ping = math.floor(LocalPlayer:GetNetworkPing() * 1000)
            local currentPing, avgPing, minPing, maxPing, quality, color = _G.UniversalUtility.Performance.UpdatePingStats(ping)
            pingCallback(currentPing, avgPing, minPing, maxPing, quality, color)
        end
    end)
end

print("[Universal Utility] Performance module loaded")
