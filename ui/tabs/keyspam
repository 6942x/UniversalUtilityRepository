local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local Config = _G.UniversalUtility.Config
local UI = _G.UniversalUtility.UI
local KeySpam = _G.UniversalUtility.KeySpam
local Debounces = _G.UniversalUtility.Debounces
local KeySpamContent = UI.TabContents["KeySpam"]

local function SetDebounce(key, duration)
    if Debounces[key] then return false end
    Debounces[key] = true
    task.delay(duration or 0.3, function() Debounces[key] = false end)
    return true
end

local KeySpamContainer = Instance.new("Frame", KeySpamContent)
KeySpamContainer.Size = UDim2.new(1, 0, 0, 280)
KeySpamContainer.BackgroundColor3 = Color3.fromRGB(35, 35, 42)
KeySpamContainer.BorderSizePixel = 0
KeySpamContainer.LayoutOrder = 1

local KeySpamCorner = Instance.new("UICorner", KeySpamContainer)
KeySpamCorner.CornerRadius = UDim.new(0, 10)

local KeySpamTitle = Instance.new("TextLabel", KeySpamContainer)
KeySpamTitle.Size = UDim2.new(1, -20, 0, 24)
KeySpamTitle.Position = UDim2.new(0, 10, 0, 10)
KeySpamTitle.BackgroundTransparency = 1
KeySpamTitle.Text = "Key Spam Configuration"
KeySpamTitle.Font = Enum.Font.GothamBold
KeySpamTitle.TextSize = 16
KeySpamTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
KeySpamTitle.TextXAlignment = Enum.TextXAlignment.Left

local SpamInput = Instance.new("TextBox", KeySpamContainer)
SpamInput.Size = UDim2.new(1, -20, 0, 40)
SpamInput.Position = UDim2.new(0, 10, 0, 50)
SpamInput.BackgroundColor3 = Color3.fromRGB(45, 45, 52)
SpamInput.Text = Config.SpamKey
SpamInput.PlaceholderText = "Enter key (A-Z, 0-9, F1-F12)"
SpamInput.Font = Enum.Font.Gotham
SpamInput.TextSize = 14
SpamInput.TextColor3 = Color3.fromRGB(255, 255, 255)
SpamInput.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
SpamInput.BorderSizePixel = 0
SpamInput.ClearTextOnFocus = false

local SpamInputCorner = Instance.new("UICorner", SpamInput)
SpamInputCorner.CornerRadius = UDim.new(0, 8)

local SpamDelayFrame, SpamDelaySlider, SpamSliderFill, SpamSliderButton, SpamDelayBox, SpamDelayLabel = UI.CreateSlider(KeySpamContainer, UDim2.new(1, -20, 0, 50), 0.05, 5, 0.1, "Spam Delay (seconds):")
SpamDelayFrame.Position = UDim2.new(0, 10, 0, 110)

local AutoSpamToggle = UI.CreateButton(KeySpamContainer, UDim2.new(0, 120, 0, 36), "OFF")
AutoSpamToggle.Position = UDim2.new(0.5, 0, 0, 185)

local AutoSpamStatus = Instance.new("TextLabel", KeySpamContainer)
AutoSpamStatus.Size = UDim2.new(1, -20, 0, 50)
AutoSpamStatus.Position = UDim2.new(0, 10, 0, 225)
AutoSpamStatus.BackgroundTransparency = 1
AutoSpamStatus.Text = "Status: Inactive"
AutoSpamStatus.Font = Enum.Font.GothamBold
AutoSpamStatus.TextSize = 16
AutoSpamStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
AutoSpamStatus.TextXAlignment = Enum.TextXAlignment.Center

local function UpdateSlider(fill, valueBox, labelElement, value, min, max, format)
    local percentage = (value - min) / (max - min)
    TweenService:Create(fill, UI.TweenPresets.Fast, {Size = UDim2.new(percentage, 0, 1, 0)}):Play()
    valueBox.Text = string.format(format, value)
end

local function UpdateSpamSlider(percentage)
    Config.SpamDelay = 0.05 + (percentage * 4.95)
    UpdateSlider(SpamSliderFill, SpamDelayBox, SpamDelayLabel, Config.SpamDelay, 0.05, 5, "%.2f")
    _G.UniversalUtility.SaveConfig()
end

SpamDelayBox.FocusLost:Connect(function()
    local value = math.clamp(tonumber(SpamDelayBox.Text) or Config.SpamDelay, 0.05, 5)
    Config.SpamDelay = value
    UpdateSpamSlider((value - 0.05) / 4.95)
end)

SpamInput.FocusLost:Connect(function()
    Config.SpamKey = SpamInput.Text:upper()
    _G.UniversalUtility.SaveConfig()
end)

local dragging = {spam = false}

SpamSliderButton.MouseButton1Down:Connect(function()
    dragging.spam = true
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging.spam = false
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        local mouseX = UserInputService:GetMouseLocation().X
        if dragging.spam then
            UpdateSpamSlider(math.clamp((mouseX - SpamDelaySlider.AbsolutePosition.X) / SpamDelaySlider.AbsoluteSize.X, 0, 1))
        end
    end
end)

AutoSpamToggle.MouseButton1Click:Connect(function()
    if not SetDebounce("Spam", 0.3) then return end
    local success, result = KeySpam.Toggle(SpamInput.Text)
    
    if success then
        TweenService:Create(AutoSpamToggle, UI.TweenPresets.Medium, {BackgroundColor3 = Color3.fromRGB(50, 220, 100)}):Play()
        AutoSpamToggle.Text = "ON"
        AutoSpamStatus.Text = "Status: Spamming " .. result
        AutoSpamStatus.TextColor3 = Color3.fromRGB(50, 220, 100)
    else
        TweenService:Create(AutoSpamToggle, UI.TweenPresets.Medium, {BackgroundColor3 = Color3.fromRGB(220, 50, 50)}):Play()
        AutoSpamToggle.Text = "OFF"
        if result then
            AutoSpamStatus.Text = "Status: " .. result
            AutoSpamStatus.TextColor3 = Color3.fromRGB(220, 50, 50)
        else
            AutoSpamStatus.Text = "Status: Inactive"
            AutoSpamStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
        end
    end
    _G.UniversalUtility.SaveConfig()
end)

_G.UniversalUtility.KeySpamTab = {
    AutoSpamToggle = AutoSpamToggle,
    AutoSpamStatus = AutoSpamStatus,
    UpdateSlider = UpdateSlider,
    UpdateSpamSlider = UpdateSpamSlider,
    SpamInput = SpamInput
}

print("[Universal Utility] KeySpam tab loaded")
