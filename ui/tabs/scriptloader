local TweenService = game:GetService("TweenService")

local Config = _G.UniversalUtility.Config
local UI = _G.UniversalUtility.UI
local ScriptLoader = _G.UniversalUtility.ScriptLoader
local Debounces = _G.UniversalUtility.Debounces
local LoaderContent = UI.TabContents["Script Loader"]

local function SetDebounce(key, duration)
    if Debounces[key] then return false end
    Debounces[key] = true
    task.delay(duration or 0.3, function() Debounces[key] = false end)
    return true
end

local LoaderContainer = Instance.new("Frame", LoaderContent)
LoaderContainer.Size = UDim2.new(1, 0, 0, 350)
LoaderContainer.BackgroundColor3 = Color3.fromRGB(35, 35, 42)
LoaderContainer.BorderSizePixel = 0
LoaderContainer.LayoutOrder = 1

local LoaderCorner = Instance.new("UICorner", LoaderContainer)
LoaderCorner.CornerRadius = UDim.new(0, 10)

local LoaderTitle = Instance.new("TextLabel", LoaderContainer)
LoaderTitle.Size = UDim2.new(1, -20, 0, 24)
LoaderTitle.Position = UDim2.new(0, 10, 0, 10)
LoaderTitle.BackgroundTransparency = 1
LoaderTitle.Text = "Script Loader"
LoaderTitle.Font = Enum.Font.GothamBold
LoaderTitle.TextSize = 16
LoaderTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
LoaderTitle.TextXAlignment = Enum.TextXAlignment.Left

local CodeEditorFrame = Instance.new("Frame", LoaderContainer)
CodeEditorFrame.Size = UDim2.new(1, -20, 0, 200)
CodeEditorFrame.Position = UDim2.new(0, 10, 0, 45)
CodeEditorFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 52)
CodeEditorFrame.BorderSizePixel = 0

local CodeEditorCorner = Instance.new("UICorner", CodeEditorFrame)
CodeEditorCorner.CornerRadius = UDim.new(0, 8)

local LineNumbersScrollFrame = Instance.new("ScrollingFrame", CodeEditorFrame)
LineNumbersScrollFrame.Size = UDim2.new(0, 40, 1, 0)
LineNumbersScrollFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
LineNumbersScrollFrame.BorderSizePixel = 0
LineNumbersScrollFrame.ScrollBarThickness = 0
LineNumbersScrollFrame.ScrollingEnabled = false
LineNumbersScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 200)

local LineNumbersCorner = Instance.new("UICorner", LineNumbersScrollFrame)
LineNumbersCorner.CornerRadius = UDim.new(0, 8)

local LineNumbers = Instance.new("TextLabel", LineNumbersScrollFrame)
LineNumbers.Size = UDim2.new(1, -5, 1, 0)
LineNumbers.BackgroundTransparency = 1
LineNumbers.Text = "1"
LineNumbers.Font = Enum.Font.Code
LineNumbers.TextSize = 12
LineNumbers.TextColor3 = Color3.fromRGB(120, 120, 120)
LineNumbers.TextXAlignment = Enum.TextXAlignment.Right
LineNumbers.TextYAlignment = Enum.TextYAlignment.Top

local Separator = Instance.new("Frame", CodeEditorFrame)
Separator.Size = UDim2.new(0, 1, 1, 0)
Separator.Position = UDim2.new(0, 40, 0, 0)
Separator.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
Separator.BorderSizePixel = 0

local LoadStringScrollFrame = Instance.new("ScrollingFrame", CodeEditorFrame)
LoadStringScrollFrame.Size = UDim2.new(1, -41, 1, 0)
LoadStringScrollFrame.Position = UDim2.new(0, 41, 0, 0)
LoadStringScrollFrame.BackgroundTransparency = 1
LoadStringScrollFrame.BorderSizePixel = 0
LoadStringScrollFrame.ScrollBarThickness = 4
LoadStringScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 150, 255)
LoadStringScrollFrame.ScrollBarImageTransparency = 0.5
LoadStringScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 200)

local LoadStringBox = Instance.new("TextBox", LoadStringScrollFrame)
LoadStringBox.Size = UDim2.new(1, -10, 1, 0)
LoadStringBox.Position = UDim2.new(0, 5, 0, 0)
LoadStringBox.BackgroundTransparency = 1
LoadStringBox.Text = Config.SavedCode
LoadStringBox.PlaceholderText = "Paste your code here..."
LoadStringBox.Font = Enum.Font.Code
LoadStringBox.TextSize = 12
LoadStringBox.TextColor3 = Color3.fromRGB(255, 255, 255)
LoadStringBox.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
LoadStringBox.BorderSizePixel = 0
LoadStringBox.TextWrapped = true
LoadStringBox.TextXAlignment = Enum.TextXAlignment.Left
LoadStringBox.TextYAlignment = Enum.TextYAlignment.Top
LoadStringBox.MultiLine = true
LoadStringBox.ClearTextOnFocus = false
LoadStringBox.TextEditable = true

local ExecuteButton = UI.CreateButton(LoaderContainer, UDim2.new(0, 200, 0, 40), "Execute Script")
ExecuteButton.Position = UDim2.new(0.5, 0, 0, 265)

local LoadStringStatus = Instance.new("TextLabel", LoaderContainer)
LoadStringStatus.Size = UDim2.new(1, -20, 0, 30)
LoadStringStatus.Position = UDim2.new(0, 10, 0, 310)
LoadStringStatus.BackgroundTransparency = 1
LoadStringStatus.Text = "Status: Ready"
LoadStringStatus.Font = Enum.Font.Gotham
LoadStringStatus.TextSize = 16
LoadStringStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
LoadStringStatus.TextXAlignment = Enum.TextXAlignment.Center

local function UpdateLineNumbers()
    local text = LoadStringBox.Text
    local lineCount = 1
    for _ in text:gmatch("\n") do
        lineCount = lineCount + 1
    end
    
    local lineNumberText = ""
    for i = 1, lineCount do
        lineNumberText = lineNumberText .. i .. "\n"
    end
    LineNumbers.Text = lineNumberText
    
    local textBounds = game:GetService("TextService"):GetTextSize(
        LoadStringBox.Text,
        LoadStringBox.TextSize,
        LoadStringBox.Font,
        Vector2.new(LoadStringBox.AbsoluteSize.X - 10, math.huge)
    )
    local newHeight = math.max(200, textBounds.Y + 20)
    LoadStringBox.Size = UDim2.new(1, -10, 0, newHeight)
    LoadStringScrollFrame.CanvasSize = UDim2.new(0, 0, 0, newHeight)
    LineNumbersScrollFrame.CanvasSize = UDim2.new(0, 0, 0, newHeight)
    LineNumbers.Size = UDim2.new(1, -5, 0, newHeight)
end

LoadStringScrollFrame:GetPropertyChangedSignal("CanvasPosition"):Connect(function()
    LineNumbersScrollFrame.CanvasPosition = Vector2.new(0, LoadStringScrollFrame.CanvasPosition.Y)
end)

LoadStringBox:GetPropertyChangedSignal("Text"):Connect(UpdateLineNumbers)

UpdateLineNumbers()

local SaveCodeTimer = nil
local SaveCodeDelay = 1.0

local function SaveCodeAutomatically()
    if SaveCodeTimer then
        task.cancel(SaveCodeTimer)
    end
    SaveCodeTimer = task.delay(SaveCodeDelay, function()
        ScriptLoader.SaveCode(LoadStringBox.Text)
        LoadStringStatus.Text = "Status: Code auto-saved"
        LoadStringStatus.TextColor3 = Color3.fromRGB(100, 200, 255)
        task.wait(2)
        if LoadStringStatus.Text == "Status: Code auto-saved" then
            LoadStringStatus.Text = "Status: Ready"
            LoadStringStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
        end
    end)
end

LoadStringBox:GetPropertyChangedSignal("Text"):Connect(SaveCodeAutomatically)

ExecuteButton.MouseButton1Click:Connect(function()
    if not SetDebounce("Execute", 0.5) then return end
    
    LoadStringStatus.Text = "Status: Executing..."
    LoadStringStatus.TextColor3 = Color3.fromRGB(255, 200, 100)
    TweenService:Create(ExecuteButton, UI.TweenPresets.Medium, {BackgroundColor3 = Color3.fromRGB(255, 200, 100)}):Play()
    
    local success, message = ScriptLoader.Execute(LoadStringBox.Text)
    
    if success then
        LoadStringStatus.Text = "Status: " .. message
        LoadStringStatus.TextColor3 = Color3.fromRGB(50, 220, 100)
        TweenService:Create(ExecuteButton, UI.TweenPresets.Medium, {BackgroundColor3 = Color3.fromRGB(50, 220, 100)}):Play()
    else
        LoadStringStatus.Text = "Status: " .. message
        LoadStringStatus.TextColor3 = Color3.fromRGB(220, 50, 50)
        TweenService:Create(ExecuteButton, UI.TweenPresets.Medium, {BackgroundColor3 = Color3.fromRGB(220, 50, 50)}):Play()
    end
    
    task.wait(2)
    if LoadStringStatus.Text:match("Error") or LoadStringStatus.Text:match("successfully") then
        LoadStringStatus.Text = "Status: Ready"
        LoadStringStatus.TextColor3 = Color3.fromRGB(180, 180, 180)
        TweenService:Create(ExecuteButton, UI.TweenPresets.Medium, {BackgroundColor3 = Color3.fromRGB(45, 45, 52)}):Play()
    end
end)

_G.UniversalUtility.ScriptLoaderTab = {
    LoadStringBox = LoadStringBox,
    ExecuteButton = ExecuteButton,
    LoadStringStatus = LoadStringStatus
}

print("[Universal Utility] Script Loader tab loaded")
